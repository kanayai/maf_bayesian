# Posterior samples analysis: analyze.py



This script performs **Bayesian Calibration** and **Posterior Prediction** for a material model using Gaussian Processes (GP). It does not run the MCMC inference itself (which is assumed to be done previously and saved); instead, it loads those results to perform analysis and prediction.

## 1. Data Loading & Preparation
The script loads three types of data:

- **Experimental Data (`data_extension_h/v`)**: Real-world measurements of Load vs. Extension at various angles (45°, 90°, 135°).
- **Simulation Data (`input_*_sim.txt`)**: Results from a Finite Element (FE) model run at known parameter settings. This serves as the "ground truth" for the physics model surrogate.
- **Posterior Samples (`results_mcmc/*.nc`)**: The results of a previously run MCMC inference, containing thousands of samples of the material parameters ($\theta$) that best fit the experimental data.

## 2. Statistical Model Definition
The script primarily analyzes results from the active non-centered models (`model_n_hv` or `model_n`) defined in `src/core/models.py`.

- **Type**: Gaussian Process Emulator with Multi-Output (Shear & Normal).
- **Goal**: To predict the system response $y$ (extension) given inputs $\mathbf{x} = (P, \alpha)$ (where $P$ is Load and $\alpha$ is Angle) and parameters $\theta$ (E1, E2, etc.).
- **Structure**:
  $$ y(\mathbf{x}) = \mu(\mathbf{x}, \theta) + \delta(\mathbf{x}) + \epsilon $$

  - $\mu(\mathbf{x}, \theta)$: Physics-based mean trend (from FE surrogate).
  - $\delta(\mathbf{x}) \sim \mathcal{GP}(0, k(\mathbf{x}, \mathbf{x}'))$: GP bias term (corrects for systematic model errors).
  - $\epsilon \sim \mathcal{N}(0, \Sigma_\epsilon)$: Random measurement noise.
  - The noise variance is modeled in **one of 3 possible ways** as per `default_config.py` (Proportional, Additive, or Constant).

### 2.1 Covariance Kernel
The GP uses a **Squared Exponential Kernel** with separate length scales for inputs $\mathbf{x}$ and parameters $\theta$:

$$ k(\mathbf{z}, \mathbf{z}') = \sigma_{emulator}^2 \exp\left( - \sum_{i} \frac{(z_i - z_i')^2}{\lambda_i^2} \right) $$

Where $\mathbf{z} = [\mathbf{x}, \theta]$ is the combined input vector.

- $\sigma_{emulator}$: Amplitude of the GP (model discrepancy magnitude).
- $\lambda_i$: Correlation length scales for each dimension (Load, Angle, E1, E2, etc.).

### 2.2 Multi-Output Likelihood
The model assumes conditional independence between Shear ($S$) and Normal ($N$) outputs given the parameters:

$$ P(\mathbf{y}_h, \mathbf{y}_v | \theta, \phi) = \mathcal{N}(\mathbf{y}_h | \boldsymbol{\mu}_h, \mathbf{K} + \mathbf{\Sigma}_\epsilon) \times \mathcal{N}(\mathbf{y}_v | \boldsymbol{\mu}_v, \mathbf{K} + \mathbf{\Sigma}_\epsilon) $$

Where the mean functions differ by direction:

- $\boldsymbol{\mu}_h = \mu_{emulator} \cdot P \cdot \sin(\alpha)$
- $\boldsymbol{\mu}_v = \mu_{emulator} \cdot P \cdot \cos(\alpha)$

## 3. Prediction Methodology

The script performs two key types of prediction, detailed in **[`prediction_methodology.qmd`](file:///Users/kai21/Projects/Research/certest/maf_bayesian/docs/prediction_methodology.qmd)**.

### 3.1 Prior Prediction

- **Input**: Parameters sampled from the **Prior** ($\theta \sim \pi(\theta)$).
- **Conditioning**: Uses **Simulation Data Only**.
- **Goal**: Validation. Checks if the model structure and priors are capable of generating the observed data *before* calibration.

### 3.2 Posterior Prediction

- **Input**: Parameters sampled from the **Posterior** ($\theta \sim p(\theta|D)$).
- **Conditioning**: Uses **Both Simulation and Experimental Data**.
- **Goal**: Prediction. Generates the best possible estimate of material behavior at the test angle, incorporating all available information.

*Note: Both methods use Cholesky decomposition to generate spatially correlated GP realizations.*

## 4. Cross-Validation via Single-Direction Training

An advanced feature of this framework is the ability to perform cross-validation by calibrating on one direction (e.g., Normal/Vertical) and predicting the response in the other (e.g., Shear/Horizontal).

### Concept
When using the single-output model (`model_n`), you can configure the training to use only one dataset direction (e.g., `direction: "v"`). However, the analysis script (`analyze.py`) is designed to generate predictions for **both** directions.

### Why this works
The physical material parameters ($\theta = \{E_1, E_2, \nu_{12}, \dots\}$) are properties of the **material**, not the test direction.

1.  **Calibration**: The MCMC inference finds the posterior distribution $p(\theta | D_v)$ that best explains the Vertical data.
2.  **Prediction**: The prediction step uses these same parameters $\theta$ but applies the physics model for the Horizontal direction:
    $$ \mu_h(P, \alpha, \theta) = \mu_{emulator}(\theta) \cdot P \cdot \sin(\alpha) $$

### Implementation
The `analyze.py` script explicitly loops over both directions, regardless of the training configuration:

```python
# analyze.py
for direction in ["v", "h"]:
    # ...
    # 1. Selects data_exp_v or data_exp_h for plotting
    # 2. Runs posterior_predict using the 'direction' flag
    # 3. Generates plots for that direction
```

**Interpretation:**

-   **Same Direction (Train "v", Plot "v")**: This is a standard **Goodness of Fit** check.
-   **Cross Direction (Train "v", Plot "h")**: This is a **Generalization** check. It asks: *"If we only knew the Normal response, how accurately could we predict the Shear response?"*

## 5. Visualization
The script generates three key plots:

1.  **Parameter Posteriors**: Histograms of the calibrated parameters ($E_1, E_2, \dots$).
2.  **Prior Prediction**: Shaded region showing what the model expected *before* calibration.
3.  **Posterior Prediction**: Shaded region showing the model's predictions *after* calibration, overlaid with the experimental data points.

## Summary
In statistical terms, this script is performing **Model Validation** and **Uncertainty Quantification**. It answers the question: *"Given the data we observed, and assuming our physics model is mostly correct but imperfect, what is the likely behavior of the material at this specific loading angle, and how confident are we?"*
