# Codebase Description



This document provides a detailed overview of the key Python scripts in the `maf_gp_bayesian` project.

## Core Library

### [`src/core/models.py`](file:///Users/kai21/Projects/Research/certest/maf_bayesian/src/core/models.py)
This is the **core library** file containing the definitions for the Gaussian Process (GP) models, covariance functions, and inference utilities using `numpyro` and `jax`.

*   **`cov_matrix_emulator`**: Defines the squared exponential covariance kernel used for the GP emulator.
*   **`model`**: The base Bayesian model definition for a single output direction. It defines priors for material parameters (`E1`, `E2`, `v12`, `v23`, `G12`) and hyperparameters.
*   **`model_n_hv`**: An advanced model that handles **both shear and normal** extension data simultaneously. It includes reparameterization for better MCMC sampling efficiency and supports optional bias terms for `E1` and `alpha`.
*   **`run_inference_hv`**: A helper function to set up and run the NUTS (No-U-Turn Sampler) MCMC inference engine using `numpyro`.
*   **`posterior_predict`**: A function to generate predictions from the trained GP model given a set of parameters. It computes the mean and standard deviation of the posterior predictive distribution.

## Inference Scripts

### [`MAF_gp_hv.py`](file:///Users/kai21/Projects/Research/certest/maf_bayesian/MAF_gp_hv.py)
This is the **main execution script** for running the Bayesian inference (now largely superseded by `analyze.py` workflows, but retains core logic).

*   **Data Loading**: Loads experimental data for both shear (`data_extension_h`) and normal (`data_extension_v`) directions, as well as simulation data.
*   **Visualization**: Plots the raw experimental data (Load vs. Extension) color-coded by angle and marker-coded by position.
*   **Inference**: Calls `run_inference_hv` (using `model_n_hv`) to perform MCMC sampling.
*   **Saving**: Saves the resulting posterior samples to a NetCDF/HDF5 file in the `results_mcmc` directory.

## Posterior Analysis Scripts

These scripts are used to analyze the results of the MCMC inference (saved in `results_mcmc`), generate plots, and perform posterior predictive checks.

### [`analyze.py`](file:///Users/kai21/Projects/Research/certest/maf_bayesian/analyze.py)
**Main analysis script** that unifies inference, prediction, and plotting.

*   **Loads Results**: Automatically finds and loads the latest `results_mcmc/*.nc` file.
*   **Prior Prediction** (Optional): Can run prior checks.
*   **Posterior Prediction**: Uses the saved posterior samples to predict the system response (Load vs. Extension) and compares it against the experimental data.
*   **Plotting**: Generates plots for posterior predictions and parameter distributions.
*   **Optimization**: Uses `jax.vmap` for fast vectorized predictions.



### [`posterior_bias_alpha.py`](file:///Users/kai21/Projects/Research/certest/maf_bayesian/posterior_bias_alpha.py)
Analyzes results from the model **with bias on the angle (`alpha`)**.

*   **Bias Handling**: Specifically handles the `b_alpha` bias terms found in the posterior samples.
*   **Prediction**: Adds the inferred bias to the input angles during prediction to account for systematic experimental errors in the loading angle.
*   **Plotting**: Includes additional plots for the posterior distribution of the bias terms (`b_alpha`).

### [`posterior_bias_E1.py`](file:///Users/kai21/Projects/Research/certest/maf_bayesian/posterior_bias_E1.py)
Analyzes results from the model **with bias on the Young's Modulus (`E1`)**.

*   **Bias Handling**: Handles `b_E1` bias terms.
*   **Prediction**: Adjusts the `E1` parameter by the inferred bias for each experiment during prediction.
*   **Plotting**: Includes plots for the posterior distribution of the `E1` bias terms.

## Utilities

### [`scripts/update_truncated_data.py`](file:///Users/kai21/Projects/Research/certest/maf_bayesian/scripts/update_truncated_data.py)
**Data Update Script**

*   **Purpose**: Updates the truncated experimental data files in `data/experimental/h` and `data/experimental/v` to match the current `max_load` configuration.
*   **Usage**: Run `python scripts/update_truncated_data.py` from the project root.
*   **Features**:
    *   Reads `max_load` from `configs/default_config.py`.
    *   Uses `data/experimental/full_experimental_data` as the immutable source.
    *   Ensures minimal datasets are up-to-date with configuration changes.

### [`scripts/compare_data.py`](file:///Users/kai21/Projects/Research/certest/maf_bayesian/scripts/compare_data.py)
**Data Verification Script**

*   **Purpose**: verifies consistency between partial and full experimental datasets.
*   **Usage**: Run `python scripts/compare_data.py` from the project root.
*   **Functionality**:
    *   Iterates through current experimental files.
    *   Searches for matching sequences in the full dataset.
    *   Reports whether files are identical, subsets (prefix/suffix/internal), or different.

